---
- name: "DEMO: OSTree upgrade - System preparation"
  hosts: image_builder
  gather_facts: true
  vars_files:
  - ../vars/main.yml
  - ../vars/secrets.yml
  tasks:

        # Install image-builder with infra.osbuild collection (https://github.com/redhat-cop/infra.osbuild)
        - name: Prepare Image Builder server
          become: true
          ansible.builtin.import_role:
            name: infra.osbuild.setup_server


        # Create microshift image
        - become: true
          ansible.builtin.import_role:
            name: infra.osbuild.builder
          vars:
            builder_request_timeout: 300
            builder_wait_compose_timeout: 2400
            builder_blueprint_name: demo-microshift
            builder_compose_type: edge-installer
            builder_pub_key: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}"
            builder_skip_repo: false
            builder_rhsm_repos:
            - "rhocp-{{ ocp_release }}-for-rhel-{{ ansible_distribution_major_version }}-{{ ansible_architecture }}-rpms"
            - "fast-datapath-for-rhel-{{ ansible_distribution_major_version }}-{{ ansible_architecture }}-rpms"
            builder_compose_pkgs:
              - microshift
              - microshift-greenboot
              - NetworkManager-wifi
              - firewalld
              - git
              - openshift-clients
            builder_compose_customizations:
              user:
                name: "admin"
                description: "Admin user"
                password: "R3dh4t1!"
                key: "{{ builder_pub_key }}"
                groups: ["users", "wheel"]
              services:
                enabled: ["microshift"]
              firewall.services:
                enabled: ["80/tcp", "443/tcp", "6443/tcp"]
            builder_kickstart_options:
              - lang en_US.UTF-8
              - keyboard us
              - timezone Etc/UTC
              - text
              - zerombr
              - clearpart --all --initlabel
              - part /boot/efi --fstype=efi --size=200
              - part /boot --fstype=xfs --asprimary --size=800
              - part swap --fstype=swap --recommended
              - part pv.01 --grow
              - volgroup rhel pv.01
              - logvol / --vgname=rhel --fstype=xfs --size=10000 --name=root
              - reboot
              - network --bootproto=dhcp
#              - user --name={{ builder_compose_customizations['user']['name'] }} {{ "--password" if builder_password is defined  }} {{ builder_password if builder_password is defined }} --group=wheel,user  # noqa yaml[line-length]
              - ostreesetup --nogpg --osname=rhel --remote=edge --url=http://{{ ansible_host }}/{{ builder_blueprint_name }}/repo/ --ref={{ builder_blueprint_ref }}
            additional_kickstart_post:
              - "{{ lookup('ansible.builtin.template', '../templates/firewall_options.j2') }}"
              - "{{ lookup('ansible.builtin.template', '../templates/{{ microshift_image_ovn_options_template }}') if microshift_image_ovn_options_template is defined | default(None) }}"
              - "{{ lookup('ansible.builtin.template', '../templates/{{ microshift_image_pull_secret_template }}') if microshift_image_pull_secret_template is defined | default(None) }}"
              - "{{ lookup('ansible.builtin.template', '../templates/{{ microshift_image_crio_proxy_template }}') if microshift_image_crio_proxy_template is defined | default(None) }}"
              - "{{ lookup('ansible.builtin.template', '../templates/{{ microshift_test_app_template }}') if microshift_test_app_template is defined | default(None) }}"
              - "cp /var/lib/microshift/resources/kubeadmin/kubeconfig ~/.kube/config"


        - debug:
            msg:  "Download the ISO image from: http://{{ ansible_host }}/{{ builder_blueprint_name }}/images/{{ builder_blueprint_output['current_version'] }}/{{ builder_blueprint_name }}_edge-installer.iso"



